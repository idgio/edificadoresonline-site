---
import BaseLayout from "@/layouts/BaseLayout.astro";
import {
  getActiveYear,
  getPredicaMonths,
  findPredicaEntry,
  normalizeImageUrl,
  isDefaultImage,
} from "@/lib/predicas";

export function getStaticPaths() {
  const year = getActiveYear();
  const months = getPredicaMonths(year);

  return months.flatMap((month) =>
    month.entries.map((entry) => ({
      params: {
        year: year.toString(),
        month: month.slug,
        slug: entry.slug,
      },
    }))
  );
}

const { year, month, slug } = Astro.params;
const yearNumber = Number(year);
const result = findPredicaEntry(yearNumber, month, slug);

if (!result) {
  throw new Error("Predica not found");
}

const { entry, month: monthData } = result;
const coverImage = normalizeImageUrl(entry.imageUrl ?? null);
const isCoverFallback = isDefaultImage(coverImage);
const monthLabel = monthData.month;

const escapeHtml = (text: string) =>
  text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

const renderInline = (text: string) =>
  escapeHtml(text).replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

const normalizeListLine = (line: string) =>
  line.trim().replace(/^[-•]\s*/, "");

const contentBlocks = entry.content
  .split("\n\n")
  .map((block) => block.trim())
  .filter(Boolean)
  .map((block) => {
    const trimmed = block.trim();
    const isListBlock = trimmed.startsWith("-") || trimmed.startsWith("•");
    if (isListBlock) {
      const items = block
        .split("\n")
        .map((line) => normalizeListLine(line))
        .filter(Boolean);
      return { type: "list", items } as const;
    }
    return { type: "paragraph", text: trimmed } as const;
  });

const formatDate = (value: string) => {
  const [year, month, day] = value.split("-").map(Number);
  if (!year || !month || !day) return value;
  const date = new Date(Date.UTC(year, month - 1, day, 12));
  return new Intl.DateTimeFormat("es-ES", {
    year: "numeric",
    month: "long",
    day: "numeric",
    timeZone: "America/El_Salvador",
  }).format(date);
};

const videoId = entry.youtube_url
  ? entry.youtube_url.split("v=")[1]?.split("&")[0]
  : null;
const embedUrl = videoId
  ? `https://www.youtube-nocookie.com/embed/${videoId}`
  : entry.youtube_url;

const relatedEntries = monthData.entries.filter(
  (item) => item.slug !== entry.slug
);

const shuffle = <T,>(items: T[]) => {
  const result = [...items];
  for (let i = result.length - 1; i > 0; i -= 1) {
    const j = Math.floor(Math.random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  return result;
};

const randomRelated = shuffle(relatedEntries);

const monthPath = `/predicas/${year}/${month}`;
---

<BaseLayout title={`${entry.title} - Prédicas - Edificadores Online`} headerClass="mb-12">
  <div class="flex flex-wrap items-center gap-4 text-sm text-[#666]">
    <a href={monthPath} class="hover:text-[#1c1c1c] transition"
      >← Volver a Prédicas de {monthLabel}</a
    >
  </div>

  <section class="grid gap-8 lg:grid-cols-[1.1fr_0.9fr] items-start">
    <div class="space-y-4">
      <div class="space-y-2">
        <h1
          class="text-3xl lg:text-4xl font-bold text-[#1c1c1c]"
          style="font-family: 'Playfair Display', serif;"
        >
          {entry.title}
        </h1>
        <p class="text-sm text-[#6a5f54]">{entry.preacher}</p>
        <p class="text-xs text-[#6a5f54]">
          {monthLabel} · {formatDate(entry.date)}
        </p>
      </div>
      <div class="space-y-3 text-sm text-[#4a4a4a] leading-relaxed">
        {contentBlocks.map((block) =>
          block.type === "list" ? (
            <ul class="list-disc pl-5 space-y-1">
              {block.items.map((item) => (
                <li set:html={renderInline(item)} />
              ))}
            </ul>
          ) : (
            <p set:html={renderInline(block.text)} />
          )
        )}
      </div>

      {entry.pdf_url && (
        <a
          href={entry.pdf_url}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 rounded-full bg-[#1c1c1c] px-5 py-2 text-xs font-semibold text-[#f7f1e7] transition hover:bg-[#0f0f0f]"
        >
          Descargar Material Didáctico
          <span
            class="grid h-5 w-5 place-items-center rounded-full border border-[#f7f1e7]"
            >→</span
          >
        </a>
      )}
    </div>

    <div class="space-y-4">
      <div class="relative w-full aspect-video rounded-2xl overflow-hidden bg-gray-900">
        {embedUrl ? (
          <iframe
            class="h-full w-full"
            src={embedUrl}
            title="YouTube video player"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen
          ></iframe>
        ) : (
          <div class="flex h-full items-center justify-center text-sm text-white">
            Video no disponible
          </div>
        )}
      </div>
    </div>
  </section>

  {relatedEntries.length > 0 && (
    <section class="mt-12 space-y-6">
      <h2 class="text-xl font-semibold text-[#1c1c1c]">Más prédicas</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {randomRelated.slice(0, 4).map((item) => (
          <a
            href={`/predicas/${year}/${month}/${item.slug}`}
            class="space-y-3"
          >
            <div
              class="relative overflow-hidden rounded-2xl h-32 bg-white border border-[#efe3d3]"
            >
              {item.imageUrl ? (
                <img
                  src={item.imageUrl}
                  alt={item.title}
                  class={`h-full w-full ${
                    isDefaultImage(item.imageUrl)
                      ? "object-contain bg-[#f7f1e7]"
                      : "object-cover"
                  }`}
                />
              ) : (
                <div class="flex h-full items-center justify-center">
                  <span class="text-xs font-semibold text-[#3f3f3f]">
                    Portada según mes
                  </span>
                </div>
              )}
            </div>
            <div class="space-y-1">
              <p class="text-sm font-semibold text-[#1c1c1c]">
                {item.title}
              </p>
              <p class="text-xs text-[#6a5f54]">Ver más...</p>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}
</BaseLayout>
