---
import BaseLayout from "@/layouts/BaseLayout.astro";
import {
  getPredicaMonths,
  findPredicaMonth,
  normalizeImageUrl,
  getActiveYear,
} from "@/lib/predicas";

export function getStaticPaths() {
  const year = getActiveYear();
  const months = getPredicaMonths(year);

  return months.map((month) => ({
    params: { year: year.toString(), month: month.slug },
  }));
}

const { year, month } = Astro.params;
const yearNumber = Number(year);
const monthData = findPredicaMonth(yearNumber, month);

if (!monthData) {
  throw new Error("Predicas month not found");
}

const coverImage = normalizeImageUrl(monthData.coverImage ?? null);
const monthTitle = monthData.month;

const getExcerpt = (text: string, limit = 160) => {
  const cleaned = text
    .replace(/\n+/g, " ")
    .replace(/[>*_`#-]/g, "")
    .replace(/\s+/g, " ")
    .trim();
  if (cleaned.length <= limit) return cleaned;
  return `${cleaned.slice(0, limit).trim()}...`;
};

const formatDate = (value: string) => {
  const [year, month, day] = value.split("-").map(Number);
  if (!year || !month || !day) return value;
  const date = new Date(Date.UTC(year, month - 1, day, 12));
  return new Intl.DateTimeFormat("es-ES", {
    year: "numeric",
    month: "long",
    day: "numeric",
    timeZone: "America/El_Salvador",
  }).format(date);
};

const entryPath = (slug: string) =>
  `/predicas/${year}/${month}/${slug}`;
---

<BaseLayout title={`Prédicas ${monthTitle} ${year} - Edificadores Online`} headerClass="mb-12">
  <section class="space-y-6">
    <div class="flex items-center gap-2 text-sm">
      <a href="/predicas" class="text-[#666] hover:text-[#1c1c1c] transition"
        >← Volver a Prédicas</a
      >
    </div>

    <div
      class="rounded-[32px] overflow-hidden bg-white border border-[#e7dccb] shadow-[0_16px_30px_rgba(17,17,17,0.08)]"
    >
      {coverImage ? (
        <div class="relative h-52 md:h-72">
          <img
            src={coverImage}
            alt={`Portada de ${monthTitle}`}
            class="h-full w-full object-cover object-center bg-[#f7f1e7]"
          />
          <div
            class="absolute inset-0 flex items-center justify-center bg-[linear-gradient(180deg,rgba(0,0,0,0)_25%,rgba(0,0,0,0.55)_100%)]"
          >
          </div>
        </div>
      ) : (
        <div class="flex h-52 md:h-72 items-center justify-center">
          <span class="text-2xl md:text-3xl font-semibold text-[#1c1c1c]">
            Portada según mes
          </span>
        </div>
      )}
    </div>

    <div class="flex items-center justify-between">
      <h2 class="text-2xl font-semibold text-[#1c1c1c]">Prédicas</h2>
      <span class="text-sm text-[#6a5f54]">{monthTitle}</span>
    </div>

    <div class="space-y-6">
      {monthData.entries.map((entry) => (
        <article class="flex flex-col gap-4 md:flex-row md:items-center">
          <div
            class="w-full md:w-48 h-36 md:h-28 rounded-2xl overflow-hidden bg-white border border-[#efe3d3]"
          >
            {entry.imageUrl ? (
              <img
                src={entry.imageUrl}
                alt={entry.title}
                class="h-full w-full object-cover object-center bg-[#f7f1e7]"
              />
            ) : (
              <div class="flex h-full items-center justify-center">
                <span class="text-xs font-semibold text-[#3f3f3f]">
                  Portada según mes
                </span>
              </div>
            )}
          </div>
          <div class="space-y-2">
            <h3 class="text-base font-semibold text-[#1c1c1c]">
              {entry.title}
            </h3>
            <p class="text-xs text-[#6a5f54]">
              {entry.preacher} · {formatDate(entry.date)}
            </p>
            <p class="text-xs text-[#6a5f54]">
              {getExcerpt(entry.content)}
            </p>
            <div class="flex flex-wrap gap-3 text-xs text-[#6a5f54]">
              <a href={entryPath(entry.slug)} class="underline">Ver más...</a>
              {entry.pdf_url && (
                <a
                  href={entry.pdf_url}
                  class="underline"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Descargar PDF
                </a>
              )}
            </div>
          </div>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>
