---
import BaseLayout from "@/layouts/BaseLayout.astro";
import {
  getActiveYear,
  getPredicaMonths,
  normalizeImageUrl,
} from "@/lib/predicas";

const year = getActiveYear();
const months = getPredicaMonths(year);
const featuredMonth = months[months.length - 1];

if (!featuredMonth) {
  throw new Error("No predicas data available");
}

const entryPath = (monthSlug: string) => `/predicas/${year}/${monthSlug}`;

const getExcerpt = (text: string, limit = 120) => {
  const cleaned = text
    .replace(/\n+/g, " ")
    .replace(/[>*_`#-]/g, "")
    .replace(/\s+/g, " ")
    .trim();
  if (cleaned.length <= limit) return cleaned;
  return `${cleaned.slice(0, limit).trim()}...`;
};

const featuredImage = normalizeImageUrl(featuredMonth?.coverImage ?? null);
const introCopy =
  "Crezcamos juntos con cada una de las prédicas de nuestros servicios de 7:00 am, 9:00 am y 11:00 am en Edificadores.";
---

<BaseLayout title="Prédicas - Edificadores Online" headerClass="mb-12">
  <section class="text-center space-y-4">
    <h1
      class="text-4xl lg:text-5xl font-bold text-[#1c1c1c]"
      style="font-family: 'Playfair Display', serif;"
    >
      Prédicas
    </h1>
    <p class="mx-auto max-w-2xl text-sm text-[#4a4a4a]">
      {introCopy}
    </p>
  </section>

  <section class="mt-10">
    <div
      class="rounded-[32px] overflow-hidden bg-white border border-[#e7dccb] shadow-[0_16px_30px_rgba(17,17,17,0.08)]"
    >
      {featuredImage ? (
        <div class="relative h-52 md:h-72">
          <img
            src={featuredImage}
            alt={`Portada de ${featuredMonth.month}`}
            class="h-full w-full object-cover object-top"
          />
          <div
            class="absolute inset-0 flex items-center justify-center bg-[linear-gradient(180deg,rgba(0,0,0,0)_25%,rgba(0,0,0,0.55)_100%)]"
          >
          </div>
        </div>
      ) : (
        <div class="flex h-52 md:h-72 items-center justify-center">
          <span class="text-2xl md:text-3xl font-semibold text-[#1c1c1c]">
            Portada según mes
          </span>
        </div>
      )}
    </div>
  </section>

  <section class="mt-12">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      {months.map((month) => {
        const cover = normalizeImageUrl(month.coverImage ?? null);
        const description = month.featuredDescription
          ? getExcerpt(month.featuredDescription, 140)
          : month.entries[0]
            ? getExcerpt(month.entries[0].content)
            : "Descripción breve.";

        return (
          <a href={entryPath(month.slug)} class="space-y-3">
            <div
              class="relative overflow-hidden rounded-2xl h-36 bg-white border border-[#efe3d3] shadow-[0_10px_20px_rgba(17,17,17,0.06)]"
            >
              {cover ? (
                <img
                  src={cover}
                  alt={`Portada de ${month.month}`}
                  class="h-full w-full object-cover"
                />
              ) : (
                <div class="flex h-full items-center justify-center">
                  <span class="text-xs font-semibold text-[#3f3f3f]">
                    Portada según mes
                  </span>
                </div>
              )}
            </div>
            <div class="space-y-1">
              <p class="text-sm font-semibold text-[#1c1c1c]">
                {month.month}
              </p>
              <p class="text-xs text-[#6a5f54]">{description}</p>
              <span class="text-xs text-[#6a5f54] underline">Ver más...</span>
            </div>
          </a>
        );
      })}
    </div>
  </section>
</BaseLayout>
